{% extends 'base.html' %}
{% load static %}
{% block title %}
    User List
{% endblock %}

{% block content %}
    <div class="container">
        {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags %} {% if message.tags == 'error' %} alert-danger {%endif%} alert-{{ message.tags }}{% endif %}" role="alert">{{ message }}</div>
            {% endfor %}
        {% endif %}
        <div class="col-md-8">
            <h3>USER List</h3>
            <table id="userTable" class="table table-striped">
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Number</th>
                    <th colspan="3">DOB</th>
                </tr>
                {% if users %}
                    {% for user in users %}
                        <tr id="user-{{ user.id }}">
                            <td class="userName userData" name="name">{{ user.name }}</td>
                            <td class="userEmail userData" name="address">{{ user.email }}</td>
                            <td class="userNumber userData" name="address">{{ user.number }}</td>
                            <td class="userAge userData" name="age">{{ user.dob }}</td>

                            <td align="center">
                                <button class="btn btn-success form-control" onClick="editUser({{ user.id }})"
                                        data-toggle="modal" data-target="#myModal" >EDIT
                                </button>
                            </td>
                            <td align="center">
                                <button class="btn btn-danger form-control" onClick="deleteUser({{ user.id }})">DELETE
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                {% endif %}
            </table>
            <a href="{% url 'add_user' %}"><h5>Add New User</h5></a>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">Ã—</span></button>
                    <h4 class="modal-title" id="myModalLabel">Update User</h4>
                </div>
                <form action="{% url 'all_user' %}" method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input class="form-control" id="form-id" name="userId" type="hidden"/>
                        <label for="name">Name</label>
                        <input class="form-control" id="form-name" name="name" type="text" />
                        <label for="email">Email</label>
                        <input class="form-control" id="form-email" name="email" type="email" />
                        <label for="number">Number</label>
                        <input class="form-control" id="form-number" name="number" type="number" />
                        <label for="dob">DOB</label>
                        <input class="form-control" id="form-dob" type="date" name="dob" min=10 max=100/>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save changes</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
{% block javascript %}
    <script>
        function editUser(id) {
            if (id) {
                tr_id = "#user-" + id;
                // need to come
                var name = $(tr_id).find(".userName").text();
                email = $(tr_id).find(".userEmail").text();
                number = $(tr_id).find(".userNumber").text();
                dob = $(tr_id).find(".userAge").text();
                val = new Date(dob)
                var dd = today.getDate()
                var mm = today.getMonth()+1
                if (mm < 10){
                  mm = '0'+String(mm)
                }
                var yy = today.getFullYear()
                val=(yy+'-'+mm+'-'+dd)
                $('#form-id').val(id);
                $('#form-name').val(name);
                $('#form-number').val(number);
                $('#form-email').val(email);
                $('#form-dob').val(val);
            }
        }

        // Delete Django Ajax Call
        function deleteUser(id) {
            var action = confirm("Are you sure you want to delete this user?");
            if (action != false) {
                $.ajax({
                    url: '{% url "delete_user" %}',
                    data: {
                        'id': id,
                    },
                    dataType: 'json',
                    success: function (data) {
                        if (data.deleted) {
                            $("#userTable #user-" + id).remove();
                        }
                    }
                });
            }
        }
    </script>
{% endblock %}